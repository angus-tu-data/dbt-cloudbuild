steps:
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Export DBT keyfile from Secret Manager"
        export DBT_KEYFILE=$(gcloud secrets versions access latest \
          --secret="DBT_PROD_KEY")
        echo "$DBT_KEYFILE" > /workspace/dbt_key.json

  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install dbt-bigquery
        export DBT_KEYFILE=/workspace/dbt_key.json
        dbt run --profiles-dir .
