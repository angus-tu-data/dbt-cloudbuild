steps:
  - name: 'python:3.11'
    entrypoint: bash
    secretEnv: ['_DBT_KEY']
    args:
      - -c
      - |
        pip install --quiet dbt-bigquery
        # 把 Secret Manager 的 JSON 寫成檔案
        echo "$_DBT_KEY" | tr -d '\r' > /workspace/keyfile.json
        export DBT_KEYFILE=/workspace/keyfile.json
        cat $DBT_KEYFILE  # 可以先驗證內容
        dbt run --project-dir=demo_dbt --profiles-dir=demo_dbt --target prod

options:
  logging: CLOUD_LOGGING_ONLY

availableSecrets:
  secretManager:
    - versionName: projects/tw-rd-data-angus-tu/secrets/DBT_PROD_KEY/versions/latest
      env: _DBT_KEY
