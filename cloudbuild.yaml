# ============================
# Cloud Build for dbt prod
# Project: tw-rd-data-angus-tu
# ============================

steps:
  # 1️⃣ Install dbt
  - name: python:3.10
    id: Install dbt
    entrypoint: bash
    args:
      - -c
      - |
        pip install --upgrade pip
        pip install dbt-bigquery

  # 2️⃣ Authenticate with GCP using Secret Manager key
  - name: gcr.io/cloud-builders/gcloud
    id: Authenticate GCP
    entrypoint: bash
    args:
      - -c
      - |
        echo "$DBT_PROD_KEY_JSON" > /tmp/prod-key.json
        export DBT_KEYFILE=/tmp/prod-key.json
        gcloud auth activate-service-account --key-file="$DBT_KEYFILE"

  # 3️⃣ dbt debug
  - name: python:3.10
    id: dbt debug
    entrypoint: bash
    args:
      - -c
      - dbt debug --target prod

  # 4️⃣ dbt build
  - name: python:3.10
    id: dbt build
    entrypoint: bash
    args:
      - -c
      - dbt build --target prod

# ============================
# Secrets
# ============================
secrets:
  - secretEnv:
      DBT_PROD_KEY_JSON: projects/tw-rd-data-angus-tu/secrets/DBT_PROD_KEY/versions/1
